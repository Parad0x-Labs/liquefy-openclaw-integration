#!/usr/bin/env bash
# --- $NULL SOVEREIGN SDK CLI WRAPPER ---
# Policy: Data Sovereignty / Path C (Public Recovery)
set -euo pipefail

IMAGE="nullaai/liquefy-decoder-public@sha256:b7a0499f38d192e7333c760fcf8e429abcff83e58610259841f2ffb525c02935"

usage() {
  cat <<EOF
Usage:
  ./liquefy version
  ./liquefy verify <archive>
  ./liquefy decompress <archive> <output>
  ./liquefy search <vault_dir> --query "<expr>" [--limit N] [--ignore-case] [--regex] [--json]
  ./liquefy openclaw --workspace ~/.openclaw --out ./openclaw-vault [--verify-mode full|fast|off] [--workers N] [--secure]

Notes:
  - Uses the public decode-only appliance (no compression, no tuning).
  - Runs offline: --network=none, read-only rootfs, dropped caps.
EOF
}

cmd="${1:-}"
if [[ -z "$cmd" ]]; then usage; exit 2; fi

case "$cmd" in
  version)
    if ! command -v docker >/dev/null 2>&1; then
      echo "ERROR: Docker is required. Please install Docker to run the hardened conduction environment." >&2
      exit 2
    fi
    echo "[+] Ensuring latest hardened machine is available..."
    docker pull "$IMAGE" >/dev/null
    docker run --rm --network=none --read-only --cap-drop=ALL "$IMAGE" version
    ;;
  verify)
    if ! command -v docker >/dev/null 2>&1; then
      echo "ERROR: Docker is required. Please install Docker to run the hardened conduction environment." >&2
      exit 2
    fi
    archive="${2:-}"
    [[ -n "$archive" ]] || { usage; exit 2; }
    echo "[+] Pulling decoder machine..."
    docker pull "$IMAGE" >/dev/null
    docker run --rm --network=none --read-only --cap-drop=ALL \
      -v "$(pwd)":/data:rw \
      "$IMAGE" verify "/data/$archive"
    ;;
  decompress)
    if ! command -v docker >/dev/null 2>&1; then
      echo "ERROR: Docker is required. Please install Docker to run the hardened conduction environment." >&2
      exit 2
    fi
    archive="${2:-}"
    output="${3:-}"
    [[ -n "$archive" && -n "$output" ]] || { usage; exit 2; }
    echo "[+] Pulling decoder machine..."
    docker pull "$IMAGE" >/dev/null
    docker run --rm --network=none --read-only --cap-drop=ALL \
      -v "$(pwd)":/data:rw \
      "$IMAGE" decompress "/data/$archive" -o "/data/$output"
    ;;
  search)
    vault_dir="${2:-}"
    [[ -n "$vault_dir" ]] || { usage; exit 2; }
    shift 2
    exec python3 "$(dirname "$0")/tools/tracevault_search.py" "$vault_dir" "$@"
    ;;
  openclaw)
    shift
    exec python3 "$(dirname "$0")/tools/liquefy_openclaw.py" "$@"
    ;;
  *)
    usage; exit 2
    ;;
esac
